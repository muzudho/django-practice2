DjangoとDocker練習[OA17o1o0] さくらVPS 備忘録

# 本題の前に

わたしは今は `さくらのVPS` を使っているので、この連載の内容で何も言及がなければ `さくらのVPS` での説明をしている。  
しかし昔は `AWS` を使っていたので、その記事が混ざっているかもしれない  

# 情報

この記事は Lesson 1. から順に全部やってこないと ソースが足りず実行できないので注意されたい  

| What is   | This is                                                                                                 |
| --------- | ------------------------------------------------------------------------------------------------------- |
| Lesson 1. | 📖 [DjangoとDockerでゲーム対局サーバーを作ろう！](https://qiita.com/muzudho1/items/eb0df0ea604e1fd9cdae) |

# 手順

## Step [OA17o1o1o0] とりあえず さくらのVPS のページへ行ってみよう

📖 [さくらのVPS](https://vps.sakura.ad.jp/)  

もう会員になっているものとして話しを進める  

## Step [OA17o1o2o0] ログインしよう

📖 [会員IDログイン](https://secure.sakura.ad.jp/vps/login?redirect=%2Fservers)  

## Step [OA17o1o2o0] レンタルサーバーを借りよう

大まかに言うと `さくらのVPS` サイトで買えるのは サーバーの利用スペース なので、  
サイトのどこかにある `新規追加` ボタンをクリックすれば、 `サーバー` または `VPS` といった名前のものを選べるはずだ。探せ。  

これから借りるサーバーの選択ページが出てくるだろう  

```plaintext
ゾーン

+---------+  +---------+  +---------+
| 東京第２ |  | 石狩第１ |  | 大阪第３ |
+---------+  +---------+  +---------+
```

👆　上の３つは　サーバーセンター　の場所だろう。  
「えっ　これだけ？」と思ってしまうが　AWS は別格なので比べてはいけない。  

あなたのデータが置いてある場所でもあり、ここがミサイルの爆撃でも受けると　あなたのデータは　飛ぶわけだ。  
あなたがどれを選ぼうと わたしは知らない。  

```plaintext
プラン

+---------+-----------+
| 毎月払い | 12ヶ月一括 |
+---------+-----------+ 

+---------+----------+---------+-----------+--------+
| プラン   | CPU      | メモリ  | ストレージ  | 金額   |
+---------+----------+---------+-----------+--------+
| 512MB   | 仮想1Core | 512MB  | SSD  25GB  |  nnn円 |
+---------+----------+---------+-----------+--------+
|   1G    | 仮想2Core |   1G   | SSD  50GB  |  nnn円 |
+---------+----------+---------+-----------+--------+
|   2G    | 仮想3Core |   2G   | SSD 100GB  | nnnn円 |
+---------+----------+---------+-----------+--------+

・
・
・
```

👆　プランというのは、月額または年額の予算をいくら注ぎこむかという話しだ  

AWS では、なんで売ってるのか分からないほど使えない安いやつ　とか  
見た感じ A より B の方がお得なケースとかあるので　選ぶのに疑心暗鬼になるが、  
それに比べれば さくらのVPS のプランは選びやすいだろう  

性能が足りなくて困っている場面に直面しているのでなければ 最低限の性能をもった一番安いのから始めるのが 平凡な選択だ  

```plaintext
サーバー設定

サーバー名（任意）
                --------------------

サーバー説明（任意）
                  --------------------

インストールするOS
  [CentOS]  [AlmaLinux]  [Rocky Linux]
  [ubuntu]  [KUSANAGI]

スタートアップスクリプト
  ……

SSH
  ……
```

👆 サーバー名が何のことか よく分からないので ASCIIコードで付けておく  

インストールするOSは、わたしは `ubuntu` にするが、あなたが何を選ぼうと わたしは知らない。  
OSを選ぶと、 管理ユーザーのパスワードの入力欄が出てくると思うので、何を入力したか 忘れないようにすること  

スタートアップスクリプトは使ったことないのでパス  

SSH は難しいので後で  

# 購入する

わたしの場合は、購入すると、10分も待ってないぐらいの感覚で、使えるようになった  

```plaintext
[さくらのVPS] - [サーバー]

サーバー一覧
-----------

名前        状態    IPアドレス  ゾーン  スペック
---------  ------
サーバー名  停止中

```


# さくらのVPSのどこにソースを置く？

例えば:  

```plaintext
    /
    └── 📂 home
        └── 📂 ubuntu
            └── 📂 repos
                └── 📂 django-practice2
                    └── 📂 src1            # ソース
                        ├── 📂 apps1        # 各種アプリケーション
                        ├── 📂 project2     # 本番用プロジェクト
                        ├── 📄 .env
                        ├── 🐳 docker-compose.yml   # `🐳 docker-compose-project2.yml` をリネーム
                        ├── 🐳 Dockerfile
                        ├── 📄 manage.py
                        └── 📄 requirements.txt
```

* git か Visual Studio Code の Remote host を使ってファイルをコピーしてほしい
* settings.py の DEBUGフラッグは下げてほしい
* `📂 project2` settings.py などに `project1` という文字が含まれていれば `project2` に変えてほしい

# コマンド

```shell
cd /home/ubuntu/repos/django-practice2/src1

docker-compose up
# ファイルを指定するなら
# docker-compose -f docker-compose-project2.yml up
```

# Dockerマシンをどうやってインストールする？

この連載では レンタルサーバーのインスタンスに Dockerマシンをインストールする方法 は説明しないが、  
👇 AWSのEC2のインスタンスのケースは 昔に記事を書いたから、参考にしてもいいし、しなくてもいい  

📖 [AWSに電子政府きふわらべをデプロイするオーバービュー（＾～＾）](https://crieit.net/posts/AWS-61a238f50f23a)  

# 備忘録

`さくらのVPS` でドッカーコンテナを起動したら、外部に公開するまで　あと２つ設定が必要。

(1)  
さくらサーバー側でポートを開く。  
セキュリティの関係上、初期設定で SSH しか開いていないので、Webの8000番ポートも通すようにする。  

(2)  
Django の settings.py に `ALLOWED_HOSTS = []` という文字列配列がある。  
ここに外部からアクセスさせる IPアドレスまたは ドメインを書くこと。  
ファイルを保存すると　自動で読込まれるので、ドッカーコンテナの再起動は必要ない。  

# Dockerコンテナの停止の方法

```shell
docker-compose down
```

📖 [Dockerイメージとコンテナの削除方法](https://qiita.com/tifa2chan/items/e9aa408244687a63a0ae)  

# 次の記事

📖 [OA17o2o0 DjangoとDocker練習O17o2o0 gitでソースをクローンしよう！](https://qiita.com/muzudho1/items/7d4c35b58d6af20e3ceb)  

# 参考にした記事

📖 [さくらレンタルサーバーにPythonのモジュールをインストール（7/5）](http://mountainwind.sakura.ne.jp/wp/2017/07/05/%E3%81%95%E3%81%8F%E3%82%89%E3%83%AC%E3%83%B3%E3%82%BF%E3%83%AB%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%81%ABpython%E3%81%AE%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%92%E3%82%A4%E3%83%B3/)  
📖 [さくらのVPS（仮想専用サーバー）に解析環境を構築する方法について](https://tellusxdp.github.io/start-python-with-tellus/environment/sakura-vps.pdf)  
